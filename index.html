<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDAM Bill Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .view {
        display: none;
      }
      .active-view {
        display: block;
      }
      #ocr-status {
        transition: all 0.3s ease-in-out;
      }
      .modal {
        display: none;
      }
      .modal.active {
        display: flex;
      }
      .spin-animation {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen"
  >
    <div class="w-full max-w-4xl mx-auto p-4 md:p-6">
      <!-- Login View -->
      <div id="login-view" class="view active-view">
        <div
          class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md mx-auto"
        >
          <h1 class="text-3xl font-bold text-center mb-2">
            PDAM Bill Calculator
          </h1>
          <p class="text-gray-400 text-center mb-8">
            Masuk dengan nama Anda dari Google Sheet.
          </p>
          <form id="login-form">
            <div class="mb-6">
              <label
                for="username"
                class="block mb-2 text-sm font-medium text-gray-300"
                >Nama Pengguna</label
              >
              <input
                type="text"
                id="username"
                class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3"
                placeholder="contoh: Zenith"
                required
              />
            </div>
            <button
              type="submit"
              class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center"
            >
              Masuk
            </button>
            <p
              id="login-error"
              class="text-red-500 text-sm mt-4 text-center"
            ></p>
          </form>
          <div class="text-center mt-4">
            <button
              id="admin-login-button"
              class="text-sm text-gray-400 hover:text-white"
            >
              Masuk sebagai Admin
            </button>
          </div>
        </div>
      </div>

      <!-- Admin View -->
      <div id="admin-view" class="view">
        <div class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">Dasbor Admin</h2>
            <button
              id="admin-logout-button"
              class="bg-gray-700 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors"
            >
              Keluar
            </button>
          </div>
          <div class="bg-gray-900 rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-gray-300">
                <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                  <tr>
                    <th scope="col" class="py-3 px-6">Nama</th>
                    <th scope="col" class="py-3 px-6">Bulan</th>
                    <th scope="col" class="py-3 px-6 text-right">
                      Angka Meter
                    </th>
                    <th scope="col" class="py-3 px-6 text-right">Penggunaan</th>
                    <th scope="col" class="py-3 px-6 text-right">Tagihan</th>
                    <th scope="col" class="py-3 px-6 text-center">
                      Foto Bukti
                    </th>
                  </tr>
                </thead>
                <tbody id="admin-table-body">
                  <!-- Admin data will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard View -->
      <div id="dashboard-view" class="view">
        <div class="bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-3xl font-bold">
                Selamat Datang, <span id="dashboard-username"></span>!
              </h2>
              <p class="text-gray-400">Berikut riwayat penggunaan air Anda.</p>
            </div>
            <div class="flex items-center space-x-4">
              <button
                id="refresh-data-button"
                title="Refresh Data"
                class="p-2 rounded-full hover:bg-gray-700 transition-colors"
              >
                <svg
                  id="refresh-icon"
                  class="w-6 h-6 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 15M20 20l-1.5-1.5A9 9 0 003.5 9"
                  ></path>
                </svg>
              </button>
              <button
                id="logout-button"
                class="bg-gray-700 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors"
              >
                Keluar
              </button>
            </div>
          </div>
          <div class="bg-gray-900 p-4 rounded-xl">
            <canvas id="usageChart"></canvas>
          </div>

          <!-- Latest Month Summary Cards -->
          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
            <div class="bg-gray-700 p-4 rounded-lg">
              <p class="text-sm text-gray-400">Penggunaan Bulan Terakhir</p>
              <p id="latest-usage" class="text-2xl font-bold text-blue-400">
                0 m³
              </p>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
              <p class="text-sm text-gray-400">Tagihan Bulan Terakhir</p>
              <p id="latest-bill" class="text-2xl font-bold text-green-400">
                Rp 0
              </p>
            </div>
          </div>

          <!-- History Table -->
          <div class="mt-6">
            <h3 class="text-xl font-semibold mb-4">Rincian Riwayat</h3>
            <div class="bg-gray-900 rounded-lg overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-300">
                  <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                    <tr>
                      <th scope="col" class="py-3 px-6">Bulan</th>
                      <th scope="col" class="py-3 px-6 text-right">
                        Angka Meter
                      </th>
                      <th scope="col" class="py-3 px-6 text-right">
                        Penggunaan (m³)
                      </th>
                      <th scope="col" class="py-3 px-6 text-right">Tagihan</th>
                      <th scope="col" class="py-3 px-6 text-center">
                        Foto Bukti
                      </th>
                    </tr>
                  </thead>
                  <tbody id="history-table-body">
                    <!-- Rows will be inserted here by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="mt-8 text-center">
            <button
              id="show-add-reading-button"
              class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 font-medium rounded-lg text-lg px-8 py-4 text-center"
            >
              Hitung Tagihan Bulan Ini
            </button>
          </div>
        </div>
      </div>

      <!-- Add Reading View -->
      <div id="add-reading-view" class="view">
        <div
          class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-auto"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Hitung Tagihan Baru</h2>
            <button
              id="back-to-dashboard-button"
              class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg"
            >
              &larr; Kembali
            </button>
          </div>
          <p id="current-month-display" class="text-gray-400 -mt-4 mb-6"></p>

          <div class="bg-gray-700 p-4 rounded-lg mb-4">
            <p class="text-sm text-gray-400">Angka Meter Sebelumnya</p>
            <p id="last-meter-reading" class="text-2xl font-semibold">0 m³</p>
          </div>

          <div class="space-y-4">
            <div>
              <label
                for="meter-image"
                class="block mb-2 text-sm font-medium text-gray-300"
                >Unggah Foto Meteran (Bukti)</label
              >
              <input
                type="file"
                id="meter-image"
                accept="image/*"
                class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"
              />
              <p id="ocr-status" class="text-sm text-yellow-400 mt-2 h-5"></p>
            </div>

            <div>
              <label
                for="current-meter-reading"
                class="block mb-2 text-sm font-medium text-gray-300"
                >Angka Meter Saat Ini (m³)</label
              >
              <input
                type="number"
                id="current-meter-reading"
                class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg block w-full p-3"
                placeholder="Masukkan angka manual atau pindai"
              />
            </div>
          </div>

          <!-- Calculation Result -->
          <div id="result-view" class="mt-6 p-6 bg-gray-900 rounded-xl hidden">
            <h3 class="text-xl font-bold mb-4 text-center">
              Perhitungan Selesai
            </h3>
            <div class="grid grid-cols-2 gap-4 text-center">
              <div>
                <p class="text-sm text-gray-400">Penggunaan Bulan Ini</p>
                <p id="result-usage" class="text-3xl font-bold text-green-400">
                  0 m³
                </p>
              </div>
              <div>
                <p class="text-sm text-gray-400">Total Tagihan</p>
                <p id="result-bill" class="text-3xl font-bold text-green-400">
                  Rp 0
                </p>
              </div>
            </div>
            <div class="mt-6 p-4 bg-gray-800 rounded-lg text-center">
              <p
                id="save-status-message"
                class="text-sm text-gray-300 h-5 mb-2"
              ></p>
              <button
                id="save-data-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm w-40"
              >
                Simpan ke Sheet
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirm-modal"
      class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4"
    >
      <div
        class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center"
      >
        <h3 id="modal-title" class="text-xl font-bold mb-4">
          Konfirmasi Timpa Data
        </h3>
        <p id="modal-body" class="text-gray-300 mb-6">
          Data untuk bulan ini sudah ada. Apakah Anda yakin ingin menimpanya?
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="modal-cancel-button"
            class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-6 rounded-lg"
          >
            Batal
          </button>
          <button
            id="modal-confirm-button"
            class="bg-red-600 hover:bg-red-500 text-white font-medium py-2 px-6 rounded-lg"
          >
            Timpa
          </button>
        </div>
      </div>
    </div>

    <!-- Image Viewer Modal -->
    <div
      id="image-modal"
      class="modal fixed inset-0 bg-black bg-opacity-80 items-center justify-center p-4 z-50"
    >
      <div
        class="bg-gray-800 p-4 rounded-2xl shadow-2xl w-full max-w-3xl relative"
      >
        <button
          id="image-modal-close"
          class="absolute -top-4 -right-4 bg-red-600 text-white rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold"
        >
          &times;
        </button>
        <img
          id="modal-image"
          src=""
          alt="Bukti Foto Meteran"
          class="w-full h-auto max-h-[80vh] object-contain rounded-lg"
        />
      </div>
    </div>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const addReadingView = document.getElementById('add-reading-view');
        const adminView = document.getElementById('admin-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username');
        const dashboardUsername = document.getElementById('dashboard-username');
        const logoutButton = document.getElementById('logout-button');
        const adminLogoutButton = document.getElementById(
          'admin-logout-button',
        );
        const showAddReadingButton = document.getElementById(
          'show-add-reading-button',
        );
        const backToDashboardButton = document.getElementById(
          'back-to-dashboard-button',
        );
        const lastMeterReadingEl =
          document.getElementById('last-meter-reading');
        const meterImageInput = document.getElementById('meter-image');
        const ocrStatus = document.getElementById('ocr-status');
        const currentMeterReadingInput = document.getElementById(
          'current-meter-reading',
        );
        const resultView = document.getElementById('result-view');
        const resultUsage = document.getElementById('result-usage');
        const resultBill = document.getElementById('result-bill');
        const saveDataButton = document.getElementById('save-data-button');
        const saveStatusMessage = document.getElementById(
          'save-status-message',
        );
        const latestUsageEl = document.getElementById('latest-usage');
        const latestBillEl = document.getElementById('latest-bill');
        const confirmModal = document.getElementById('confirm-modal');
        const modalConfirmButton = document.getElementById(
          'modal-confirm-button',
        );
        const modalCancelButton = document.getElementById(
          'modal-cancel-button',
        );
        const historyTableBody = document.getElementById('history-table-body');
        const refreshDataButton = document.getElementById(
          'refresh-data-button',
        );
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminTableBody = document.getElementById('admin-table-body');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const imageModalClose = document.getElementById('image-modal-close');

        let chart = null;
        let allUsersData = [];
        let currentUserData = null;
        let lastReading = 0;
        let dataToSaveOnClick = {};
        let selectedFile = null;

        // --- Google Sheet Configuration ---
        const SHEET_ID = '14JQvLHFkNIah3s0Tq5kbQYCbsQEF6SjZXvUZ21hVpVg';
        const GID = '0'; // GID for the first sheet
        const sheetURL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
        const SCRIPT_URL =
          'https://script.google.com/macros/s/AKfycbyf80MnYK3_Kfx00YkB-aI-hZmKuz2oC5cbI2XDXLlxYu-TbIR1h4JOqOlZ_ojrT8SH/exec';

        // --- Data Fetching and Processing ---
        async function fetchSheetData(isAdmin = false) {
          try {
            const url = isAdmin
              ? SCRIPT_URL
              : `${sheetURL}&t=${new Date().getTime()}`;
            const options = isAdmin
              ? { method: 'GET', redirect: 'follow' }
              : { cache: 'no-store' };
            const response = await fetch(url, options);

            if (!response.ok) {
              throw new Error(
                `Network response was not ok: ${response.statusText}`,
              );
            }

            if (isAdmin) {
              return await response.json();
            } else {
              const csvText = await response.text();
              return parseCSV(csvText);
            }
          } catch (error) {
            console.error('Error fetching data:', error);
            loginError.textContent = 'Gagal memuat data. Periksa koneksi Anda.';
            return [];
          }
        }

        function robustSplit(rowStr) {
          const result = [];
          let current = '';
          let inQuote = false;
          for (let i = 0; i < rowStr.length; i++) {
            const char = rowStr[i];
            if (char === '"' && (i === 0 || rowStr[i - 1] !== '\\')) {
              inQuote = !inQuote;
            } else if (char === ',' && !inQuote) {
              result.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current);
          return result.map((v) => v.trim().replace(/^"|"$/g, ''));
        }

        function parseCSV(text) {
          const rows = text.split('\n').map((row) => row.trim());

          const subHeaderRowIndex = rows.findIndex((row) =>
            row.toLowerCase().includes('meteran,penggunaan,tagihan'),
          );
          if (subHeaderRowIndex === -1) {
            return [];
          }
          const subHeaderRow = robustSplit(rows[subHeaderRowIndex]);

          const monthHeaderRowIndex = subHeaderRowIndex - 1;
          if (monthHeaderRowIndex < 0) {
            return [];
          }
          const monthHeaderRow = robustSplit(rows[monthHeaderRowIndex]);

          const dataRows = rows.slice(subHeaderRowIndex + 1).filter((row) => {
            const cols = robustSplit(row);
            return (
              cols.length > 1 &&
              !isNaN(parseInt(cols[0], 10)) &&
              cols[1] &&
              cols[1].trim() !== ''
            );
          });

          const users = {};

          dataRows.forEach((rowStr) => {
            const rowData = robustSplit(rowStr);
            const name = rowData[1].trim();
            if (!name) return;

            if (!users[name]) {
              users[name] = { name: name, readings: [] };
            }

            let currentMonth = '';
            for (let i = 2; i < subHeaderRow.length; i++) {
              if (monthHeaderRow[i]) {
                currentMonth = monthHeaderRow[i];
              }
              if (!currentMonth) continue;
              if (i >= rowData.length || !rowData[i]) continue;

              const subHeader = subHeaderRow[i];
              const value = rowData[i];

              let reading = users[name].readings.find(
                (r) => r.month === currentMonth,
              );
              if (!reading) {
                reading = {
                  month: currentMonth,
                  meteran: NaN,
                  penggunaan: NaN,
                  tagihan: NaN,
                  foto: null,
                };
                users[name].readings.push(reading);
              }

              if (subHeader === 'Meteran')
                reading.meteran = parseInt(value, 10);
              if (subHeader === 'Penggunaan')
                reading.penggunaan = parseInt(value, 10);
              if (subHeader === 'Tagihan')
                reading.tagihan = parseInt(
                  (value || '').replace(/[^0-9]/g, ''),
                  10,
                );
              if (
                subHeader.toLowerCase().includes('image') ||
                subHeader.toLowerCase().includes('foto')
              ) {
                reading.foto = value;
              }
            }
          });

          return Object.values(users).map((user) => {
            user.readings = user.readings.filter(
              (r) => !isNaN(r.meteran) && r.month,
            );
            return user;
          });
        }

        // --- Authentication ---
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          loginError.textContent = 'Mencoba masuk...';
          allUsersData = await fetchSheetData(false);
          const username = usernameInput.value.trim();
          const user = allUsersData.find(
            (u) => u.name.toLowerCase() === username.toLowerCase(),
          );
          if (user) {
            currentUserData = user;
            showDashboard();
          } else {
            loginError.textContent =
              'Pengguna tidak ditemukan. Silakan periksa nama.';
          }
        });

        logoutButton.addEventListener('click', () => {
          currentUserData = null;
          usernameInput.value = '';
          loginError.textContent = '';
          showLogin();
        });

        adminLogoutButton.addEventListener('click', () => {
          showLogin();
        });

        // --- View Management ---
        function showView(view) {
          document
            .querySelectorAll('.view')
            .forEach((v) => v.classList.remove('active-view'));
          view.classList.add('active-view');
        }

        function showLogin() {
          showView(loginView);
        }

        function showDashboard() {
          dashboardUsername.textContent = currentUserData.name;
          if (currentUserData.readings && currentUserData.readings.length > 0) {
            const latestReading =
              currentUserData.readings[currentUserData.readings.length - 1];
            latestUsageEl.textContent = `${latestReading.penggunaan || 0} m³`;
            latestBillEl.textContent = `Rp ${(
              latestReading.tagihan || 0
            ).toLocaleString('id-ID')}`;
          } else {
            latestUsageEl.textContent = 'Tidak ada data';
            latestBillEl.textContent = 'Tidak ada data';
          }
          renderChart();
          renderHistoryTable();
          showView(dashboardView);
        }

        async function showAdminDashboard() {
          const adminData = await fetchSheetData(true);
          adminTableBody.innerHTML = '';
          if (adminData.status === 'success') {
            adminData.data.forEach((item) => {
              const row = document.createElement('tr');
              row.className = 'bg-gray-800 border-b border-gray-700';

              let photoCell = 'Tidak Ada';
              if (item.foto) {
                photoCell = `<button data-img-url="${item.foto}" class="view-photo-button text-blue-400 hover:underline">Lihat Foto</button>`;
              }

              row.innerHTML = `
                            <td class="py-4 px-6 font-medium whitespace-nowrap">${
                              item.nama
                            }</td>
                            <td class="py-4 px-6">${item.bulan}</td>
                            <td class="py-4 px-6 text-right">${
                              item.meteran
                            }</td>
                            <td class="py-4 px-6 text-right">${
                              item.penggunaan
                            } m³</td>
                            <td class="py-4 px-6 text-right">Rp ${item.tagihan.toLocaleString(
                              'id-ID',
                            )}</td>
                            <td class="py-4 px-6 text-center">${photoCell}</td>
                         `;
              adminTableBody.appendChild(row);
            });
          }
          showView(adminView);
        }

        function showAddReading() {
          lastReading =
            currentUserData.readings.length > 0
              ? currentUserData.readings.slice(-1)[0].meteran
              : 0;
          lastMeterReadingEl.textContent = `${lastReading} m³`;
          const date = new Date();
          const monthYear = date.toLocaleString('default', {
            month: 'long',
            year: 'numeric',
          });
          document.getElementById(
            'current-month-display',
          ).textContent = `Menghitung untuk: ${monthYear}`;
          currentMeterReadingInput.value = '';
          meterImageInput.value = '';
          ocrStatus.textContent = '';
          resultView.classList.add('hidden');
          saveStatusMessage.textContent = '';
          showView(addReadingView);
        }

        function renderHistoryTable() {
          historyTableBody.innerHTML = '';
          if (
            !currentUserData.readings ||
            currentUserData.readings.length === 0
          ) {
            historyTableBody.innerHTML = `<tr><td colspan="5" class="py-4 px-6 text-center text-gray-400">Tidak ada data riwayat.</td></tr>`;
            return;
          }
          const reversedReadings = [...currentUserData.readings].reverse();
          reversedReadings.forEach((reading) => {
            const row = document.createElement('tr');
            row.className = 'bg-gray-800 border-b border-gray-700';
            let photoCell = reading.foto
              ? `<button data-img-url="${reading.foto}" class="view-photo-button text-blue-400 hover:underline">Lihat</button>`
              : 'N/A';

            row.innerHTML = `
                        <td class="py-4 px-6 font-medium whitespace-nowrap">${
                          reading.month
                        }</td>
                        <td class="py-4 px-6 text-right">${reading.meteran}</td>
                        <td class="py-4 px-6 text-right">${
                          reading.penggunaan
                        } m³</td>
                        <td class="py-4 px-6 text-right">Rp ${reading.tagihan.toLocaleString(
                          'id-ID',
                        )}</td>
                        <td class="py-4 px-6 text-center">${photoCell}</td>
                    `;
            historyTableBody.appendChild(row);
          });
        }

        function renderChart() {
          const ctx = document.getElementById('usageChart').getContext('2d');
          const labels = currentUserData.readings.map((r) => r.month);
          const usageData = currentUserData.readings.map((r) => r.penggunaan);
          const billData = currentUserData.readings.map((r) => r.tagihan);
          if (chart) {
            chart.destroy();
          }
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Penggunaan (m³)',
                  data: usageData,
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  yAxisID: 'yUsage',
                  tension: 0.3,
                  fill: true,
                },
                {
                  label: 'Tagihan (Rp)',
                  data: billData,
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  yAxisID: 'yBill',
                  tension: 0.3,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              interaction: { mode: 'index', intersect: false },
              scales: {
                x: {
                  grid: { color: 'rgba(255, 255, 255, 0.1)' },
                  ticks: { color: '#d1d5db' },
                },
                yUsage: {
                  type: 'linear',
                  position: 'left',
                  title: {
                    display: true,
                    text: 'Penggunaan (m³)',
                    color: '#3b82f6',
                  },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' },
                  ticks: { color: '#d1d5db' },
                },
                yBill: {
                  type: 'linear',
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Tagihan (Rp)',
                    color: '#10b981',
                  },
                  grid: { drawOnChartArea: false },
                  ticks: {
                    color: '#d1d5db',
                    callback: function (value) {
                      return 'Rp' + value / 1000 + 'k';
                    },
                  },
                },
              },
            },
          });
        }

        function calculateBill(currentReading) {
          const usage = currentReading - lastReading;
          if (usage < 0)
            return {
              usage: 0,
              bill: 0,
              error: 'Angka saat ini tidak boleh lebih rendah dari sebelumnya.',
            };
          let bill = 0;
          if (usage <= 20) {
            bill = 20000;
          } else {
            bill = 20000 + (usage - 20) * 3000;
          }
          return { usage, bill, error: null };
        }

        currentMeterReadingInput.addEventListener('input', () => {
          const currentReading = parseInt(currentMeterReadingInput.value, 10);
          if (!isNaN(currentReading) && currentReading >= lastReading) {
            const { usage, bill } = calculateBill(currentReading);
            resultUsage.textContent = `${usage} m³`;
            resultBill.textContent = `Rp ${bill.toLocaleString('id-ID')}`;
            resultView.classList.remove('hidden');
          } else {
            resultView.classList.add('hidden');
          }
        });

        meterImageInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          selectedFile = file;
          ocrStatus.textContent = 'Membaca gambar...';
          try {
            const {
              data: { text },
            } = await Tesseract.recognize(file, 'eng');
            const numbers = text.match(/\d+/g);
            if (numbers) {
              const foundNumber = numbers.join('');
              currentMeterReadingInput.value = foundNumber;
              currentMeterReadingInput.dispatchEvent(new Event('input'));
              ocrStatus.textContent = `Angka ditemukan: ${foundNumber}`;
            } else {
              ocrStatus.textContent =
                'Tidak dapat menemukan angka pada gambar.';
            }
          } catch (error) {
            console.error('OCR Error:', error);
            ocrStatus.textContent = 'Gagal memproses gambar.';
          }
        });

        showAddReadingButton.addEventListener('click', showAddReading);
        backToDashboardButton.addEventListener('click', showDashboard);

        function fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = (error) => reject(error);
          });
        }

        async function executeSave(dataToSave) {
          saveDataButton.textContent = 'Menyimpan...';
          saveDataButton.disabled = true;
          saveStatusMessage.textContent = 'Mengirim data ke sheet...';
          saveDataButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          saveDataButton.classList.add('bg-gray-500');

          try {
            if (selectedFile) {
              dataToSave.imageData = await fileToBase64(selectedFile);
              dataToSave.mimeType = selectedFile.type;
              selectedFile = null;
            }

            const response = await fetch(SCRIPT_URL, {
              method: 'POST',
              mode: 'cors',
              redirect: 'follow',
              headers: {
                'Content-Type': 'text/plain;charset=utf-8',
              },
              body: JSON.stringify(dataToSave),
            });

            if (!response.ok) {
              throw new Error(
                `Kesalahan Jaringan! Status: ${response.status}. Pastikan skrip di-deploy dengan akses 'Anyone'.`,
              );
            }

            const result = await response.json();

            if (result.status === 'success') {
              saveDataButton.textContent = 'Tersimpan!';
              saveDataButton.classList.remove('bg-gray-500');
              saveDataButton.classList.add('bg-green-600');
              saveStatusMessage.textContent = 'Data disimpan! Memuat ulang...';

              dataToSave.foto = result.imageUrl;

              const existingReadingIndex = currentUserData.readings.findIndex(
                (r) => r.month.toLowerCase() === dataToSave.month.toLowerCase(),
              );
              if (existingReadingIndex > -1) {
                currentUserData.readings[existingReadingIndex] = dataToSave;
              } else {
                currentUserData.readings.push(dataToSave);
              }

              setTimeout(() => {
                showDashboard();
              }, 1500);
            } else {
              throw new Error(
                result.message || 'Skrip mengembalikan kesalahan.',
              );
            }
          } catch (error) {
            console.error('Error saving data:', error);
            saveDataButton.textContent = 'Error!';
            saveDataButton.classList.remove('bg-gray-500');
            saveDataButton.classList.add('bg-red-600');
            saveStatusMessage.textContent = `Error: ${error.message}`;
          } finally {
            setTimeout(() => {
              saveDataButton.textContent = 'Simpan ke Sheet';
              saveDataButton.disabled = false;
              saveDataButton.classList.remove('bg-green-600', 'bg-red-600');
              saveDataButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
              saveStatusMessage.textContent = '';
            }, 6000);
          }
        }

        saveDataButton.addEventListener('click', () => {
          const meteran = currentMeterReadingInput.value;
          const usageText = resultUsage.textContent.replace(' m³', '');
          const billText = resultBill.textContent.replace(/[^0-9]/g, '');
          const date = new Date();
          const monthName = date.toLocaleString('default', { month: 'long' });

          dataToSaveOnClick = {
            name: currentUserData.name,
            month: monthName,
            meteran: parseInt(meteran, 10),
            penggunaan: parseInt(usageText, 10),
            tagihan: parseInt(billText, 10),
          };

          const readingExists = currentUserData.readings.some(
            (r) => r.month.toLowerCase() === monthName.toLowerCase(),
          );

          if (readingExists) {
            confirmModal.classList.add('active');
          } else {
            executeSave(dataToSaveOnClick);
          }
        });

        modalConfirmButton.addEventListener('click', () => {
          confirmModal.classList.remove('active');
          executeSave(dataToSaveOnClick);
        });

        modalCancelButton.addEventListener('click', () => {
          confirmModal.classList.remove('active');
        });

        async function refreshDashboardData() {
          const icon = document.getElementById('refresh-icon');
          icon.classList.add('spin-animation');
          refreshDataButton.disabled = true;

          try {
            allUsersData = await fetchSheetData(false);
            const user = allUsersData.find(
              (u) =>
                u.name.toLowerCase() === currentUserData.name.toLowerCase(),
            );
            if (user) {
              currentUserData = user;
              showDashboard();
            } else {
              logoutButton.click();
            }
          } catch (error) {
            console.error('Gagal memuat ulang data:', error);
          } finally {
            icon.classList.remove('spin-animation');
            refreshDataButton.disabled = false;
          }
        }
        refreshDataButton.addEventListener('click', refreshDashboardData);

        adminLoginButton.addEventListener('click', () => {
          const password = prompt('Masukkan kata sandi admin:', '');
          if (password === 'admin123') {
            // Simple password check
            showAdminDashboard();
          } else if (password) {
            alert('Kata sandi salah.');
          }
        });

        // --- IMAGE MODAL LOGIC (FIXED) ---
        document.body.addEventListener('click', (e) => {
          if (e.target.classList.contains('view-photo-button')) {
            const originalUrl = e.target.dataset.imgUrl;
            // Extract file ID from a standard Google Drive sharing URL
            const fileIdMatch = originalUrl.match(/d\/(.*?)\//);
            if (fileIdMatch && fileIdMatch[1]) {
              const fileId = fileIdMatch[1];
              // Use the direct image viewing URL format
              const directImageUrl = `https://drive.google.com/uc?id=${fileId}`;
              modalImage.src = directImageUrl;
              imageModal.classList.add('active');
            } else {
              alert('Tautan gambar tidak valid atau format tidak dikenali.');
            }
          }
        });

        imageModalClose.addEventListener('click', () => {
          imageModal.classList.remove('active');
          modalImage.src = '';
        });
        imageModal.addEventListener('click', (e) => {
          if (e.target === imageModal) {
            imageModal.classList.remove('active');
            modalImage.src = '';
          }
        });

        // Initial load
        showLogin();
      });
    </script>
  </body>
</html>
